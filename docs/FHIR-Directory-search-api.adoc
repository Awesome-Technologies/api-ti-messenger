:source-highlighter: highlight.js

= FHIR-Directory Search-API

The FHIR-Directory contains entries for healthcare services provided by organizations as well as practitioner entries. This page describes how to use the FHIR-Directory /search endpoint. The specification of the FHIR-Directory (https://fachportal.gematik.de/fachportal-import/files/gemSpec_VZD_FHIR_Directory_V1.1.0.pdf[gemSpec_VZD_FHIR_Directory v1.1.0]) contains information about the endpoints and authentication methods.

The FHIR Profiles are defined in the https://simplifier.net/vzd-fhir-directory[FHIR-Directory Simplifier project].

In generell FHIR allows various search capabilities. The https://www.hl7.org/fhir/search.html[FHIR search] page describes in detail the search framework.
The search always begins at a HealthcareService or a PractitionerRole ressource.

== Full text search

IMPORTANT: Full text search is not yet supported by the FHIR-Directory

The search parameters, _text and _content, are used for full text search.

=== Authentication

The /search endpoint requires a valid jwt in the Authorization header. In order to get the jwt the following steps must be performed.

1. Login to the matrix homeserver
2. Get the Matrix OpenID Token
3. Get the jwt from the /tim-authenticate endpoint

.Example: Login to the matrix homeserver
[source,]
----
REQUEST
POST https://matrix.dev.service-ti.de/_matrix/client/r0/login
HEADER
{"User-Agent"=>"Faraday v2.6.0", "Content-Type"=>"application/json"}
BODY
{"type":"m.login.password","user":"mxid","password":"password"}

RESPONSE
STATUS 200
HEADER
{"date"=>"Tue, 25 Oct 2022 08:25:34 GMT", "server"=>"Synapse/1.53.0", "content-type"=>"application/json", "cache-control"=>"no-cache, no-store, must-revalidate", "access-control-allow-origin"=>"*", "access-control-allow-methods"=>"GET, HEAD, POST, PUT, DELETE, OPTIONS", "access-control-allow-headers"=>"X-Requested-With, Content-Type, Authorization, Date", "transfer-encoding"=>"chunked"}
BODY
{
  "user_id": "@<userid>:matrix.dev.service-ti.de",
  "access_token": "syt_ZXR0cjAy_JjbHoMZhkIfxeiaCaNHN_2LGskp",
  "home_server": "matrix.dev.service-ti.de",
  "device_id": "FSEPQFDOXU"
}
----
.Example: Get the Matrix OpenID Token
[source,]
----
REQUEST
POST https://matrix.dev.service-ti.de/_matrix/client/v3/user/@ettr02:matrix.dev.service-ti.de/openid/request_token?access_token=syt_ZXR0cjAy_JjbHoMZhkIfxeiaCaNHN_2LGskp
HEADER
{"User-Agent"=>"Faraday v2.6.0", "Content-Type"=>"application/json"}
BODY
{}

RESPONSE
STATUS 200
HEADER
{"date"=>"Tue, 25 Oct 2022 08:25:35 GMT", "server"=>"Synapse/1.53.0", "content-type"=>"application/json", "cache-control"=>"no-cache, no-store, must-revalidate", "access-control-allow-origin"=>"*", "access-control-allow-methods"=>"GET, HEAD, POST, PUT, DELETE, OPTIONS", "access-control-allow-headers"=>"X-Requested-With, Content-Type, Authorization, Date", "transfer-encoding"=>"chunked"}
BODY
{
  "access_token": "OhkRxRtoFVWfdKwEYxpgtplV",
  "token_type": "Bearer",
  "matrix_server_name": "matrix.dev.service-ti.de",
  "expires_in": 3600
}
----
.Example: Get the jwt from the /tim-authenticate endpoint
[source,]
----
REQUEST
GET https://fhir-directory-test.vzd.ti-dienste.de/tim-authenticate?mxId=matrix.dev.service-ti.de
HEADER
{"User-Agent"=>"Faraday v2.6.0", "Content-Type"=>"application/json", "X-Matrix-OpenID-Token"=>"OhkRxRtoFVWfdKwEYxpgtplV", "X-Matrix-Server-Name"=>"matrix.dev.service-ti.de"}

RESPONSE
STATUS 200
HEADER
{"date"=>"Tue, 25 Oct 2022 08:31:25 GMT", "server"=>"Apache", "etag"=>"\"0919146fd23aa4c8094a9b642d25b7060\"", "content-type"=>"application/json", "content-length"=>"453"}
BODY
{
  "jwt": "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJpc3MiOiJodHRwczovL2ZoaXItZGlyZWN0b3J5LXRlc3QudnpkLnRpLWRpZW5zdGUuZGUvdGltLWF1dGhlbnRpY2F0ZSIsImF1ZCI6Imh0dHBzOi8vZmhpci1kaXJlY3RvcnktdGVzdC52emQudGktZGllbnN0ZS5kZS9zZWFyY2giLCJzdWIiOiJAZXR0cjAyOm1hdHJpeC5kZXYuc2VydmljZS10aS5kZSIsImlhdCI6MTY2NjY4NjY4NSwiZXhwIjoxNjY2NzczMDg1fQ.Q8wZjDNiJt8m5fTHEXMCGzZYo7zGdWjtJ5qvpTyfklOXby5n9mt8uWOYQGeD1MdAu6Cy213nd1PwrBR25W2CyQ",
  "token_type": "bearer",
  "expires_in": 86400
}

----

=== FHIR /search Request

.Example: FHIR /search Request
[source,]
----
REQUEST
GET https://fhir-directory-test.vzd.ti-dienste.de/search/HealthcareService?organization.active=true&_count=2&_include=HealthcareService:endpoint&_include=HealthcareService:location&_include=HealthcareService:organization&_pretty=true
HEADER
{"User-Agent"=>"Faraday v2.6.0", "Content-Type"=>"application/json", "Authorization"=>"Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJpc3MiOiJodHRwczovL2ZoaXItZGlyZWN0b3J5LXRlc3QudnpkLnRpLWRpZW5zdGUuZGUvdGltLWF1dGhlbnRpY2F0ZSIsImF1ZCI6Imh0dHBzOi8vZmhpci1kaXJlY3RvcnktdGVzdC52emQudGktZGllbnN0ZS5kZS9zZWFyY2giLCJzdWIiOiJAZXR0cjAyOm1hdHJpeC5kZXYuc2VydmljZS10aS5kZSIsImlhdCI6MTY2NjY4OTQ2OCwiZXhwIjoxNjY2Nzc1ODY4fQ.b58Pc_zecezYrqOPe_Gsfnx9ehQGoMO0OPqX7nGNyIVfUGAeo6pV5r_WXrtg70gq4lY1j1khZQV7zXWd20eDcA"}
RESPONSE
STATUS 200
HEADER
{"date"=>"Tue, 25 Oct 2022 09:17:49 GMT", "server"=>"Apache", "x-powered-by"=>"HAPI FHIR 5.6.0 REST Server (FHIR Server; FHIR 4.0.1/R4)", "x-request-id"=>"z8dxOrnrg6DN37DD", "last-modified"=>"Tue, 25 Oct 2022 09:17:48 GMT", "content-type"=>"application/fhir+json;charset=UTF-8", "transfer-encoding"=>"chunked"}
BODY
{
  "resourceType": "Bundle",
  "id": "bd3b14bb-b456-4803-9720-f63af94774c8",
  "meta": {
    "lastUpdated": "2022-10-25T11:17:48.964+02:00"
  },
  "type": "searchset",
  "total": 2,
  "entry": [
    {
      "fullUrl": "https://fhir-directory-test.vzd.ti-dienste.de/search/HealthcareService/2735300",
      "resource": {
        "resourceType": "HealthcareService",
        "id": "2735300",
        "meta": {
          "versionId": "1",
          "lastUpdated": "2022-08-31T18:15:37.867+02:00",
          "source": "#s0lLf9tTclCIsOiR",
          "profile": [
            "https://gematik.de/fhir/directory/StructureDefinition/HealthcareServiceDirectory",
            "http://hl7.org/fhir/StructureDefinition/HealthcareService"
          ]
        },
        "text": {
          "status": "generated",
          "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by Arvato QA at 2022-08-31T18:15:37+02:00\ndata model version:2\nprofile version   :0.8.0-beta6</div>"
        },
        "identifier": [
          {
            "system": "http://hl7.org/fhir/sid/us-npi",
            "value": "2efc99ad-f825-43d2-aa49-ab4e4a5ee0cd"
          }
        ],
        "providedBy": {
          "reference": "Organization/2735297"
        },
        "specialty": [
          {
            "coding": [
              {
                "system": "urn:oid:1.3.6.1.4.1.19376.3.276.1.5.5",
                "code": "FOR",
                "display": "Forschung"
              }
            ]
          }
        ],
        "location": [
          {
            "reference": "Location/2735299"
          }
        ],
        "endpoint": [
          {
            "reference": "Endpoint/2735298"
          }
        ]
      },
      "search": {
        "mode": "match"
      }
    },
    {
      "fullUrl": "https://fhir-directory-test.vzd.ti-dienste.de/search/HealthcareService/2668716",
      "resource": {
        "resourceType": "HealthcareService",
        "id": "2668716",
        "meta": {
          "versionId": "1",
          "lastUpdated": "2022-08-31T17:47:37.380+02:00",
          "source": "#lUklnUrrVxFYWubt",
          "profile": [
            "https://gematik.de/fhir/directory/StructureDefinition/HealthcareServiceDirectory",
            "http://hl7.org/fhir/StructureDefinition/HealthcareService"
          ]
        },
        "text": {
          "status": "generated",
          "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by Arvato QA at 2022-08-31T17:47:37+02:00\ndata model version:2\nprofile version   :0.8.0-beta6</div>"
        },
        "identifier": [
          {
            "system": "http://hl7.org/fhir/sid/us-npi",
            "value": "e87e62ff-c887-4062-99d9-1a2f4c9a469d"
          }
        ],
        "providedBy": {
          "reference": "Organization/2668713"
        },
        "location": [
          {
            "reference": "Location/2668715"
          }
        ],
        "endpoint": [
          {
            "reference": "Endpoint/2668714"
          }
        ]
      },
      "search": {
        "mode": "match"
      }
    },
    {
      "fullUrl": "https://fhir-directory-test.vzd.ti-dienste.de/search/Organization/2668713",
      "resource": {
        "resourceType": "Organization",
        "id": "2668713",
        "meta": {
          "versionId": "1",
          "lastUpdated": "2022-08-31T17:47:37.380+02:00",
          "source": "#lUklnUrrVxFYWubt",
          "profile": [
            "https://gematik.de/fhir/directory/StructureDefinition/OrganizationDirectory",
            "http://hl7.org/fhir/StructureDefinition/Organization"
          ]
        },
        "text": {
          "status": "generated",
          "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by Arvato QA at 2022-08-31T17:47:37+02:00\ndata model version:2\nprofile version   :0.8.0-beta6</div>"
        },
        "identifier": [
          {
            "system": "http://hl7.org/fhir/sid/us-npi",
            "value": "98c7cd1e-c00d-4877-bc8e-f209181b16e0"
          },
          {
            "type": {
              "coding": [
                {
                  "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                  "code": "PRN"
                }
              ]
            },
            "system": "https://gematik.de/fhir/sid/telematik-id",
            "value": "1-2arvtst-ap000250"
          }
        ],
        "active": true,
        "type": [
          {
            "coding": [
              {
                "system": "https://gematik.de/fhir/directory/CodeSystem/OrganizationProfessionOID",
                "code": "1.2.276.0.76.4.271",
                "display": "Betriebsst√§tte PKV-Verband"
              }
            ]
          }
        ],
        "name": "Organisation 1-2arvtst-ap000250",
        "alias": [
          "Organisation 1-2arvtst-ap000250"
        ]
      },
      "search": {
        "mode": "include"
      }
    },
    {
      "fullUrl": "https://fhir-directory-test.vzd.ti-dienste.de/search/Organization/2735297",
      "resource": {
        "resourceType": "Organization",
        "id": "2735297",
        "meta": {
          "versionId": "1",
          "lastUpdated": "2022-08-31T18:15:37.867+02:00",
          "source": "#s0lLf9tTclCIsOiR",
          "profile": [
            "https://gematik.de/fhir/directory/StructureDefinition/OrganizationDirectory",
            "http://hl7.org/fhir/StructureDefinition/Organization"
          ]
        },
        "text": {
          "status": "generated",
          "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Generated by Arvato QA at 2022-08-31T18:15:37+02:00\ndata model version:2\nprofile version   :0.8.0-beta6</div>"
        },
        "identifier": [
          {
            "system": "http://hl7.org/fhir/sid/us-npi",
            "value": "b8d901d9-7094-423e-9ea6-f684a53352a6"
          },
          {
            "type": {
              "coding": [
                {
                  "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                  "code": "PRN"
                }
              ]
            },
            "system": "https://gematik.de/fhir/sid/telematik-id",
            "value": "1-2arvtst-ap005006"
          }
        ],
        "active": true,
        "type": [
          {
            "coding": [
              {
                "system": "https://gematik.de/fhir/directory/CodeSystem/OrganizationProfessionOID",
                "code": "1.2.276.0.76.4.51",
                "display": "Zahnarztpraxis"
              }
            ]
          }
        ],
        "name": "Organisation 1-2arvtst-ap005006",
        "alias": [
          "Organisation 1-2arvtst-ap005006"
        ]
      },
      "search": {
        "mode": "include"
      }
    }
  ]
}
----
