<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1678px" preserveAspectRatio="none" style="width:2665px;height:1678px;background:#FFFFFF;" version="1.1" viewBox="0 0 2665 1678" width="2665px" zoomAndPan="magnify"><defs/><g><rect fill="#F8F8F8" height="1666.6328" style="stroke:#181818;stroke-width:0.5;" width="582.5" x="635.5" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="181" x="833.75" y="18.0669">TI-Messenger Anbieter A</text><rect fill="#F8F8F8" height="1666.6328" style="stroke:#181818;stroke-width:0.5;" width="583.5" x="1472" y="6"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="190" x="1666.25" y="18.0669">TI-Messenger Anbieter B7</text><rect fill="#FFFFFF" height="1423.9141" style="stroke:#181818;stroke-width:1.0;" width="10" x="235.5" y="159.4219"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="714.5" y="395.6172"/><rect fill="#FFFFFF" height="710.0625" style="stroke:#181818;stroke-width:1.0;" width="10" x="714.5" y="873.2734"/><rect fill="#FFFFFF" height="117.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="1123.5" y="484.1484"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="1275" y="188.5547"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1275" y="1218.8047"/><rect fill="#FFFFFF" height="117.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="1557" y="719.4766"/><rect fill="#FFFFFF" height="490" style="stroke:#181818;stroke-width:1.0;" width="10" x="1557" y="1020.0703"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1966" y="630.9453"/><rect fill="#FFFFFF" height="578.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="1966" y="960.6719"/><rect fill="#FFFFFF" height="1099.6484" style="stroke:#181818;stroke-width:1.0;" width="10" x="2429" y="366.4844"/><rect height="119.6641" style="stroke:#000000;stroke-width:1.5;fill:none;" width="1336" x="10" y="106.0234"/><rect height="605.4531" style="stroke:#000000;stroke-width:1.5;fill:none;" width="2649" x="10" y="239.6875"/><rect height="541.2656" style="stroke:#000000;stroke-width:1.5;fill:none;" width="2313" x="181" y="1035.0703"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="52" x2="52" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="240" x2="240" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="719.5" x2="719.5" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1128" x2="1128" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1280" x2="1280" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1562" x2="1562" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="1970.5" x2="1970.5" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="2434" x2="2434" y1="89.0234" y2="1593.3359"/><line style="stroke:#181818;stroke-width:0.5;fill:none;stroke-dasharray:5.0,5.0;" x1="2616" x2="2616" y1="89.0234" y2="1593.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="20" y="85.7217">Nutzer A</text><ellipse cx="52.5" cy="21.2266" fill="#E3E3E3" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M52.5,29.2266 L52.5,56.2266 M39.5,37.2266 L65.5,37.2266 M52.5,56.2266 L39.5,71.2266 M52.5,56.2266 L65.5,71.2266 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="20" y="1605.3311">Nutzer A</text><ellipse cx="52.5" cy="1617.1328" fill="#E3E3E3" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M52.5,1625.1328 L52.5,1652.1328 M39.5,1633.1328 L65.5,1633.1328 M52.5,1652.1328 L39.5,1667.1328 M52.5,1652.1328 L65.5,1667.1328 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99" x="191" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="198" y="77.7217">TI-M Client A</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="99" x="191" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="85" x="198" y="1612.3311">TI-M Client A</text><rect fill="#E3E3E3" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="160" x="639.5" y="25.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="146" x="646.5" y="45.1279">Messenger-Service A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="649" y="61.4248">(Messenger-Proxy +</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="675" y="77.7217">Homeserver)</text><rect fill="#E3E3E3" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="160" x="639.5" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="146" x="646.5" y="1612.3311">Messenger-Service A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="649" y="1628.6279">(Messenger-Proxy +</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="675" y="1644.9248">Homeserver)</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="171" x="1043" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="157" x="1050" y="77.7217">Registrierungsdienst A</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="171" x="1043" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="157" x="1050" y="1612.3311">Registrierungsdienst A</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1224" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1231" y="77.7217">FHIR-Directory</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="1224" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="98" x="1231" y="1612.3311">FHIR-Directory</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="172" x="1476" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="158" x="1483" y="77.7217">Registrierungsdienst B</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="172" x="1476" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="158" x="1483" y="1612.3311">Registrierungsdienst B</text><rect fill="#E3E3E3" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="1890.5" y="25.1328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="1897.5" y="45.1279">Messenger-Service B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="1900.5" y="61.4248">(Messenger-Proxy +</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1926.5" y="77.7217">Homeserver)</text><rect fill="#E3E3E3" height="62.8906" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="1890.5" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="1897.5" y="1612.3311">Messenger-Service B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="1900.5" y="1628.6279">(Messenger-Proxy +</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="89" x="1926.5" y="1644.9248">Homeserver)</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100" x="2384" y="57.7266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2391" y="77.7217">TI-M Client B</text><rect fill="#E3E3E3" height="30.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="100" x="2384" y="1592.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="2391" y="1612.3311">TI-M Client B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="2583" y="85.7217">Nutzer B</text><ellipse cx="2616" cy="21.2266" fill="#E3E3E3" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M2616,29.2266 L2616,56.2266 M2603,37.2266 L2629,37.2266 M2616,56.2266 L2603,71.2266 M2616,56.2266 L2629,71.2266 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="2583" y="1605.3311">Nutzer B</text><ellipse cx="2616" cy="1617.1328" fill="#E3E3E3" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M2616,1625.1328 L2616,1652.1328 M2603,1633.1328 L2629,1633.1328 M2616,1652.1328 L2603,1667.1328 M2616,1652.1328 L2629,1667.1328 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#FFFFFF" height="1423.9141" style="stroke:#181818;stroke-width:1.0;" width="10" x="235.5" y="159.4219"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="714.5" y="395.6172"/><rect fill="#FFFFFF" height="710.0625" style="stroke:#181818;stroke-width:1.0;" width="10" x="714.5" y="873.2734"/><rect fill="#FFFFFF" height="117.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="1123.5" y="484.1484"/><rect fill="#FFFFFF" height="29.1328" style="stroke:#181818;stroke-width:1.0;" width="10" x="1275" y="188.5547"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1275" y="1218.8047"/><rect fill="#FFFFFF" height="117.6641" style="stroke:#181818;stroke-width:1.0;" width="10" x="1557" y="719.4766"/><rect fill="#FFFFFF" height="490" style="stroke:#181818;stroke-width:1.0;" width="10" x="1557" y="1020.0703"/><rect fill="#FFFFFF" height="44.2656" style="stroke:#181818;stroke-width:1.0;" width="10" x="1966" y="630.9453"/><rect fill="#FFFFFF" height="578.5313" style="stroke:#181818;stroke-width:1.0;" width="10" x="1966" y="960.6719"/><rect fill="#FFFFFF" height="1099.6484" style="stroke:#181818;stroke-width:1.0;" width="10" x="2429" y="366.4844"/><path d="M10,106.0234 L74,106.0234 L74,113.1563 L64,123.1563 L10,123.1563 L10,106.0234 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="119.6641" style="stroke:#000000;stroke-width:1.5;" width="1336" x="10" y="106.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="119.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="164" x="89" y="118.2339">[Suche im FHIR-Directory]</text><polygon fill="#181818" points="223.5,155.4219,233.5,159.4219,223.5,163.4219,227.5,159.4219" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="52.5" x2="229.5" y1="159.4219" y2="159.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="59.5" y="139.2231">möchte TI-M Kontakt zum</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="59.5" y="154.356">chatten finden</text><polygon fill="#181818" points="1263,184.5547,1273,188.5547,1263,192.5547,1267,188.5547" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="245.5" x2="1269" y1="188.5547" y2="188.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="252.5" y="183.4888">FHIR search request</text><polygon fill="#181818" points="256.5,213.6875,246.5,217.6875,256.5,221.6875,252.5,217.6875" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="250.5" x2="1279" y1="217.6875" y2="217.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="239" x="262.5" y="212.6216">FHIR response mit MXID von Nutzer B</text><path d="M10,239.6875 L74,239.6875 L74,246.8203 L64,256.8203 L10,256.8203 L10,239.6875 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="605.4531" style="stroke:#000000;stroke-width:1.5;" width="2649" x="10" y="239.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="25" y="252.7544">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="372" x="89" y="251.8979">[Tauscht bei persönlichem Treffen MXID mit Nutzer B aus]</text><polygon fill="#181818" points="2604,273.9531,2614,277.9531,2604,281.9531,2608,277.9531" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="52.5" x2="2610" y1="277.9531" y2="277.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="226" x="59.5" y="272.8872">Kontaktdaten austauschen per App</text><polygon fill="#181818" points="223.5,318.2188,233.5,322.2188,223.5,326.2188,227.5,322.2188" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="52.5" x2="229.5" y1="322.2188" y2="322.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="59.5" y="302.02">MXID von Nutzer B</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="59.5" y="317.1528">zu Kontakten hinzufügen</text><polygon fill="#181818" points="2450,362.4844,2440,366.4844,2450,370.4844,2446,366.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="2444" x2="2615" y1="366.4844" y2="366.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="2456" y="346.2856">MXID von Nutzer A</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="2456" y="361.4185">zu Kontakten hinzufügen</text><polygon fill="#181818" points="702.5,391.6172,712.5,395.6172,702.5,399.6172,706.5,395.6172" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="245.5" x2="708.5" y1="395.6172" y2="395.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="379" x="252.5" y="390.5513">POST /_matrix/client/r0/user/{userId}/openid/request_token</text><polygon fill="#181818" points="256.5,435.8828,246.5,439.8828,256.5,443.8828,252.5,439.8828" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="250.5" x2="718.5" y1="439.8828" y2="439.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="445" x="262.5" y="419.6841">HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",...,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271" x="262.5" y="434.8169">"matrix_server_name": "example.com",...}</text><polygon fill="#181818" points="1111.5,480.1484,1121.5,484.1484,1111.5,488.1484,1115.5,484.1484" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="245.5" x2="1117.5" y1="484.1484" y2="484.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="252.5" y="463.9497">invite von Nutzer B ist erlaubt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="252.5" y="479.0825">(Auth Header mit Matrix-OpenID-Token)</text><polygon fill="#181818" points="730.5,524.4141,720.5,528.4141,730.5,532.4141,726.5,528.4141" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="724.5" x2="1122.5" y1="528.4141" y2="528.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="736.5" y="508.2153">GET /openid/userinfo/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="380" x="736.5" y="523.3481">request header, Authorization: Bearer Matrix-OpenID-Token</text><polygon fill="#181818" points="1111.5,568.6797,1121.5,572.6797,1111.5,576.6797,1115.5,572.6797" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="719.5" x2="1117.5" y1="572.6797" y2="572.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="726.5" y="552.481">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="726.5" y="567.6138">(Result Body MXID des Nutzers)activate rd</text><polygon fill="#181818" points="256.5,597.8125,246.5,601.8125,256.5,605.8125,252.5,601.8125" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="250.5" x2="1127.5" y1="601.8125" y2="601.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="262.5" y="596.7466">HTTP 200 OK</text><polygon fill="#181818" points="1987,626.9453,1977,630.9453,1987,634.9453,1983,630.9453" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1981" x2="2428" y1="630.9453" y2="630.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="379" x="1993" y="625.8794">POST /_matrix/client/r0/user/{userId}/openid/request_token</text><polygon fill="#181818" points="2417,671.2109,2427,675.2109,2417,679.2109,2421,675.2109" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1971" x2="2423" y1="675.2109" y2="675.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="429" x="1978" y="655.0122">HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="291" x="1978" y="670.145">..., "matrix_server_name": "example.com",...}</text><polygon fill="#181818" points="1578,715.4766,1568,719.4766,1578,723.4766,1574,719.4766" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1572" x2="2428" y1="719.4766" y2="719.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="189" x="1584" y="699.2778">invite von Nutzer A ist erlaubt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="254" x="1584" y="714.4106">(Auth Header mit Matrix-OpenID-Token)</text><polygon fill="#181818" points="1959,759.7422,1969,763.7422,1959,767.7422,1963,763.7422" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1567" x2="1965" y1="763.7422" y2="763.7422"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1574" y="743.5435">GET /openid/userinfo/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="380" x="1574" y="758.6763">request header, Authorization: Bearer Matrix-OpenID-Token</text><polygon fill="#181818" points="1578,804.0078,1568,808.0078,1578,812.0078,1574,808.0078" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1572" x2="1970" y1="808.0078" y2="808.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="1584" y="787.8091">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="1584" y="802.9419">(Result Body MXID des Nutzers)activate rd</text><polygon fill="#181818" points="2417,833.1406,2427,837.1406,2417,841.1406,2421,837.1406" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1562" x2="2423" y1="837.1406" y2="837.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="82" x="1569" y="832.0747">HTTP 200 OK</text><polygon fill="#181818" points="702.5,869.2734,712.5,873.2734,702.5,877.2734,706.5,873.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="245.5" x2="708.5" y1="873.2734" y2="873.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="79" x="252.5" y="868.2075">create room</text><polygon fill="#181818" points="256.5,898.4063,246.5,902.4063,256.5,906.4063,252.5,902.4063" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="250.5" x2="713.5" y1="902.4063" y2="902.4063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="87" x="262.5" y="897.3403">room created</text><polygon fill="#181818" points="702.5,927.5391,712.5,931.5391,702.5,935.5391,706.5,931.5391" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="245.5" x2="708.5" y1="931.5391" y2="931.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="252.5" y="926.4731">invite von Nutzer A an Nutzer B</text><polygon fill="#181818" points="1954,956.6719,1964,960.6719,1954,964.6719,1958,960.6719" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="724.5" x2="1960" y1="960.6719" y2="960.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="731.5" y="955.606">invite von Nutzer A an Nutzer B</text><polygon fill="#181818" points="1578,1016.0703,1568,1020.0703,1578,1024.0703,1574,1020.0703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1572" x2="1965" y1="1020.0703" y2="1020.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1584" y="984.7388">REST Operation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="290" x="1584" y="999.8716">IsAllowedCommunication(src=MXID Nutzer A,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="1588" y="1015.0044">dst=MXID Nutzer B)</text><path d="M181,1035.0703 L245,1035.0703 L245,1042.2031 L235,1052.2031 L181,1052.2031 L181,1035.0703 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="541.2656" style="stroke:#000000;stroke-width:1.5;" width="2313" x="181" y="1035.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19" x="196" y="1048.1372">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="201" x="260" y="1047.2808">[invite von Nutzer A ist erlaubt]</text><polygon fill="#181818" points="1954,1069.3359,1964,1073.3359,1954,1077.3359,1958,1073.3359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1567" x2="1960" y1="1073.3359" y2="1073.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="1574" y="1068.27">Response true</text><polygon fill="#181818" points="2417,1098.4688,2427,1102.4688,2417,1106.4688,2421,1102.4688" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1976" x2="2423" y1="1102.4688" y2="1102.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="1983" y="1097.4028">invite von Nutzer A an Nutzer B</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="2494" y1="1111.4688" y2="1111.4688"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="217" x="186" y="1121.6792">[invite von Nutzer A nicht erlaubt]</text><line style="stroke:#181818;stroke-width:1.0;" x1="1567" x2="1609" y1="1161.5391" y2="1161.5391"/><line style="stroke:#181818;stroke-width:1.0;" x1="1609" x2="1609" y1="1161.5391" y2="1174.5391"/><line style="stroke:#181818;stroke-width:1.0;" x1="1568" x2="1609" y1="1174.5391" y2="1174.5391"/><polygon fill="#181818" points="1578,1170.5391,1568,1174.5391,1578,1178.5391,1574,1174.5391" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="1574" y="1141.3403">hashA = hash(MXID Nutzer A),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192" x="1574" y="1156.4731">hashB = hash(MXID Nutzer B)</text><polygon fill="#181818" points="1296,1214.8047,1286,1218.8047,1296,1222.8047,1292,1218.8047" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1290" x2="1556" y1="1218.8047" y2="1218.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="1302" y="1198.606">REST Operation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="1302" y="1213.7388">WhereIs(hashA), WhereIs(hashB)</text><polygon fill="#181818" points="1545,1259.0703,1555,1263.0703,1545,1267.0703,1549,1263.0703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1280" x2="1551" y1="1263.0703" y2="1263.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="1287" y="1242.8716">Response (hashA is in PractitionerDir),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="248" x="1287" y="1258.0044">Response (hashB is in OrganizationDir)</text><line style="stroke:#181818;stroke-width:1.0;" x1="1567" x2="1609" y1="1292.2031" y2="1292.2031"/><line style="stroke:#181818;stroke-width:1.0;" x1="1609" x2="1609" y1="1292.2031" y2="1305.2031"/><line style="stroke:#181818;stroke-width:1.0;" x1="1568" x2="1609" y1="1305.2031" y2="1305.2031"/><polygon fill="#181818" points="1578,1301.2031,1568,1305.2031,1578,1309.2031,1574,1305.2031" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="1574" y="1287.1372">Cache Response (1 Tag)</text><line style="stroke:#181818;stroke-width:1.0;" x1="1567" x2="1609" y1="1394.8672" y2="1394.8672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1609" x2="1609" y1="1394.8672" y2="1407.8672"/><line style="stroke:#181818;stroke-width:1.0;" x1="1568" x2="1609" y1="1407.8672" y2="1407.8672"/><polygon fill="#181818" points="1578,1403.8672,1568,1407.8672,1578,1411.8672,1574,1407.8672" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="1574" y="1329.27">Decision[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="286" x="1574" y="1344.4028">if hashB is in organization directory then true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="1574" y="1359.5356">else if hashA is in practitioner directory</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="297" x="1578" y="1374.6685">and hashB is in practitioner directory then true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="65" x="1574" y="1389.8013">else false]</text><polygon fill="#181818" points="1954,1433,1964,1437,1954,1441,1958,1437" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1567" x2="1960" y1="1437" y2="1437"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="1574" y="1431.9341">Response true</text><polygon fill="#181818" points="2422,1462.1328,2432,1466.1328,2422,1470.1328,2426,1466.1328" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="1976" x2="2428" y1="1466.1328" y2="1466.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="1983" y="1461.0669">invite von Nutzer A an Nutzer B</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="181" x2="2494" y1="1475.1328" y2="1475.1328"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="152" x="186" y="1485.3433">[Invite ist nicht erlaubt]</text><polygon fill="#181818" points="1954,1506.0703,1964,1510.0703,1954,1514.0703,1958,1510.0703" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="1562" x2="1960" y1="1510.0703" y2="1510.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="1569" y="1505.0044">Response false</text><polygon fill="#181818" points="735.5,1535.2031,725.5,1539.2031,735.5,1543.2031,731.5,1539.2031" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="729.5" x2="1970" y1="1539.2031" y2="1539.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335" x="741.5" y="1534.1372">ERROR: invite von Nutzer A an Nutzer B nicht erlaubt</text><polygon fill="#181818" points="256.5,1564.3359,246.5,1568.3359,256.5,1572.3359,252.5,1568.3359" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="250.5" x2="713.5" y1="1568.3359" y2="1568.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="335" x="262.5" y="1563.27">ERROR: invite von Nutzer A an Nutzer B nicht erlaubt</text><!--MD5=[1afb69eaedac3cacad9db0efeb26d6d8]
@startuml TI-Messenger communication control without PASSporT
/'
Vorteile:
- bessere Kompatibilität mit Matrix API
- einfachere Architektur
- keine Signaturprüfung von PASSporT im Messenger-Proxy
  - kein download von Signatur-, CA- und Root-Zertifikaten erforderlich (Schnittstelle und
    Spezifikation fehlen noch in aktueller Spec)
  - keine Abhängigkeit mehr zu PT Infrastructure
- Bessere Latenz bei Suchen im FHIR-Dir
  - einheitliche Schnittstelle im FHIR-Dir für TIM und KIM 2.0
  - geringere Abhängigkeit vom FHIR-Dir
- Ermöglicht TI 2.0 Zero Trust Architektur (Policy Decision Point (PDP) ist entweder in
  Registrierungsdienst integriert oder eigenständige Komponente, Policy Enforcement Point ist der Messenger-Proxy)
  - einfache Erweiterung um zusätzliche Policies im PDP möglich (z. B. für Versicherte)
  - Sicherheit von TIM wird durch TIM-Komponenten kontrolliert (und nicht durch das FHIR-Dir)
- Bessere UX für Austausch von TI-M Adressen bei persönlichem Kontakt.
  - Austausch von TIM Adressen grundsätzlich auch remote möglich

Was muss getan werden, um ohne PASSporTs auszukommen?
- PASSporT aus der TI-M Spec entfernen
- PASSporT aus der FHIR-Dir Spec entfernen
- REST Operationen am Messenger-Proxy spezifizieren (invite von MXIDs erlauben und Erlaubnis widerrufen,
  Dauer der Erlaubnis als Parameter)
- zusätzliche REST Operationen an I_TIM_Provider_Services
- Erläuternde Beschreibung der Abläufe zwischen Messenger-Proxy und Registrierungsdienst
'/
!pragma layout smetana
'!include ../includes/gem-tim.iuml
'!include ../includes/gem-tim-monochrome.iuml
skinparam monochrome true

actor a as "Nutzer A"
participant cl as "TI-M Client A"
box TI-Messenger Anbieter A #GhostWhite
participant mp as "Messenger-Service A\n(Messenger-Proxy +\nHomeserver)"
participant rd as "Registrierungsdienst A"
end box
participant fd as "FHIR-Directory"
box TI-Messenger Anbieter B7 #GhostWhite
participant rdb as "Registrierungsdienst B"
participant mpb as "Messenger-Service B\n(Messenger-Proxy +\nHomeserver)"
end box
participant clb as "TI-M Client B"
actor b as "Nutzer B"

alt Suche im FHIR-Directory
a -> cl: möchte TI-M Kontakt zum\nchatten finden
activate cl
cl -> fd: FHIR search request
activate fd
fd - -> cl: FHIR response mit MXID von Nutzer B
deactivate fd
end
alt Tauscht bei persönlichem Treffen MXID mit Nutzer B aus
a -> b: Kontaktdaten austauschen per App
a -> cl: MXID von Nutzer B\nzu Kontakten hinzufügen
b -> clb: MXID von Nutzer A\nzu Kontakten hinzufügen
activate clb
cl -> mp: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate mp
mp - -> cl: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",...,\n"matrix_server_name": "example.com",...}
deactivate mp
cl -> rd: invite von Nutzer B ist erlaubt\n(Auth Header mit Matrix-OpenID-Token)
activate rd
rd -> mp: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
mp - -> rd: HTTP 200 OK\n(Result Body MXID des Nutzers)activate rd
rd - -> cl: HTTP 200 OK
deactivate rd
clb -> mpb: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate mpb
mpb - -> clb: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",\n..., "matrix_server_name": "example.com",...}
deactivate mpb
clb -> rdb: invite von Nutzer A ist erlaubt\n(Auth Header mit Matrix-OpenID-Token)
activate rdb
rdb -> mpb: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
mpb - -> rdb: HTTP 200 OK\n(Result Body MXID des Nutzers)activate rd
rdb - -> clb: HTTP 200 OK
deactivate rdb
end
cl -> mp: create room
activate mp
mp - -> cl: room created

' Invite
cl -> mp: invite von Nutzer A an Nutzer B
mp -> mpb: invite von Nutzer A an Nutzer B
activate mpb
mpb -> rdb: REST Operation\nIsAllowedCommunication(src=MXID Nutzer A,\n dst=MXID Nutzer B)
activate rdb
alt invite von Nutzer A ist erlaubt
rdb - -> mpb: Response true
mpb -> clb: invite von Nutzer A an Nutzer B
else invite von Nutzer A nicht erlaubt
rdb -> rdb: hashA = hash(MXID Nutzer A),\nhashB = hash(MXID Nutzer B)
rdb -> fd: REST Operation\nWhereIs(hashA), WhereIs(hashB)
activate fd
fd - -> rdb: Response (hashA is in PractitionerDir),\nResponse (hashB is in OrganizationDir)
deactivate fd
rdb -> rdb: Cache Response (1 Tag)
rdb -> rdb: Decision[\nif hashB is in organization directory then true\nelse if hashA is in practitioner directory\n and hashB is in practitioner directory then true\nelse false]
rdb - -> mpb: Response true
mpb -> clb: invite von Nutzer A an Nutzer B
deactivate clb
else Invite ist nicht erlaubt
rdb - -> mpb: Response false
deactivate rdb
mpb -> mp: ERROR: invite von Nutzer A an Nutzer B nicht erlaubt
deactivate mpb
mp - -> cl: ERROR: invite von Nutzer A an Nutzer B nicht erlaubt
end
deactivate mp
deactivate cl
@enduml

@startuml TI-Messenger communication control without PASSporT
!pragma layout smetana
skinparam monochrome true

actor a as "Nutzer A"
participant cl as "TI-M Client A"
box TI-Messenger Anbieter A #GhostWhite
participant mp as "Messenger-Service A\n(Messenger-Proxy +\nHomeserver)"
participant rd as "Registrierungsdienst A"
end box
participant fd as "FHIR-Directory"
box TI-Messenger Anbieter B7 #GhostWhite
participant rdb as "Registrierungsdienst B"
participant mpb as "Messenger-Service B\n(Messenger-Proxy +\nHomeserver)"
end box
participant clb as "TI-M Client B"
actor b as "Nutzer B"

alt Suche im FHIR-Directory
a -> cl: möchte TI-M Kontakt zum\nchatten finden
activate cl
cl -> fd: FHIR search request
activate fd
fd - -> cl: FHIR response mit MXID von Nutzer B
deactivate fd
end
alt Tauscht bei persönlichem Treffen MXID mit Nutzer B aus
a -> b: Kontaktdaten austauschen per App
a -> cl: MXID von Nutzer B\nzu Kontakten hinzufügen
b -> clb: MXID von Nutzer A\nzu Kontakten hinzufügen
activate clb
cl -> mp: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate mp
mp - -> cl: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",...,\n"matrix_server_name": "example.com",...}
deactivate mp
cl -> rd: invite von Nutzer B ist erlaubt\n(Auth Header mit Matrix-OpenID-Token)
activate rd
rd -> mp: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
mp - -> rd: HTTP 200 OK\n(Result Body MXID des Nutzers)activate rd
rd - -> cl: HTTP 200 OK
deactivate rd
clb -> mpb: POST /_matrix/client/r0/user/{userId}/openid/request_token
activate mpb
mpb - -> clb: HTTP 200 OK, Result body {"access_token": "Matrix-OpenID-Token",\n..., "matrix_server_name": "example.com",...}
deactivate mpb
clb -> rdb: invite von Nutzer A ist erlaubt\n(Auth Header mit Matrix-OpenID-Token)
activate rdb
rdb -> mpb: GET /openid/userinfo/\nrequest header, Authorization: Bearer Matrix-OpenID-Token
mpb - -> rdb: HTTP 200 OK\n(Result Body MXID des Nutzers)activate rd
rdb - -> clb: HTTP 200 OK
deactivate rdb
end
cl -> mp: create room
activate mp
mp - -> cl: room created

cl -> mp: invite von Nutzer A an Nutzer B
mp -> mpb: invite von Nutzer A an Nutzer B
activate mpb
mpb -> rdb: REST Operation\nIsAllowedCommunication(src=MXID Nutzer A,\n dst=MXID Nutzer B)
activate rdb
alt invite von Nutzer A ist erlaubt
rdb - -> mpb: Response true
mpb -> clb: invite von Nutzer A an Nutzer B
else invite von Nutzer A nicht erlaubt
rdb -> rdb: hashA = hash(MXID Nutzer A),\nhashB = hash(MXID Nutzer B)
rdb -> fd: REST Operation\nWhereIs(hashA), WhereIs(hashB)
activate fd
fd - -> rdb: Response (hashA is in PractitionerDir),\nResponse (hashB is in OrganizationDir)
deactivate fd
rdb -> rdb: Cache Response (1 Tag)
rdb -> rdb: Decision[\nif hashB is in organization directory then true\nelse if hashA is in practitioner directory\n and hashB is in practitioner directory then true\nelse false]
rdb - -> mpb: Response true
mpb -> clb: invite von Nutzer A an Nutzer B
deactivate clb
else Invite ist nicht erlaubt
rdb - -> mpb: Response false
deactivate rdb
mpb -> mp: ERROR: invite von Nutzer A an Nutzer B nicht erlaubt
deactivate mpb
mp - -> cl: ERROR: invite von Nutzer A an Nutzer B nicht erlaubt
end
deactivate mp
deactivate cl
@enduml

PlantUML version 1.2022.5(Sat Apr 30 10:55:52 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>